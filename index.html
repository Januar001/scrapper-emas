<style>
    .harga-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 700px;
        margin: 20px auto;
        padding: 25px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #eef;
        overflow: hidden;
    }
    .harga-container h2 {
        text-align: center;
        margin-top: 10px;
        margin-bottom: 10px;
        color: #1a237e;
    }
    
    /* --- STYLE BARU UNTUK KONTROL CHART --- */
    .chart-controls {
        display: flex;
        flex-wrap: wrap; /* Biar rapi di HP */
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px; /* Jarak antar grup tombol */
    }
    .chart-controls div {
        display: flex;
        border-radius: 6px;
        background-color: #f4f6ff;
        padding: 4px;
    }
    .chart-controls button {
        border: none;
        padding: 8px 12px;
        font-size: 0.9em;
        font-weight: 600;
        background-color: transparent;
        color: #555;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .chart-controls button.active {
        background-color: #3f51b5;
        color: white;
        box-shadow: 0 2px 5px rgba(63, 81, 181, 0.3);
    }
    .chart-controls button:not(.active):hover {
        background-color: #e8eaf6;
    }
    /* ------------------------------------- */

    .harga-chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 15px;
        margin-bottom: 30px;
    }
    .harga-info {
        text-align: center;
        font-size: 0.95em;
        font-weight: 600;
        color: #555;
        margin-bottom: 25px;
        background-color: #f4f6ff;
        padding: 10px;
        border-radius: 8px;
        line-height: 1.5;
    }
    .harga-tabel { width: 100%; border-collapse: collapse; }
    .harga-tabel th, .harga-tabel td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #eceff1; }
    .harga-tabel th { background-color: #3f51b5; color: white; font-size: 1em; }
    .harga-tabel tr:nth-child(even) { background-color: #f9f9fd; }
    .harga-tabel tr:hover { background-color: #f0f2ff; }
    .harga-tabel td:first-child { font-weight: 600; color: #333; }
    .harga-loading { text-align: center; color: #777; font-style: italic; padding: 20px; }

    @media (max-width: 600px) {
        .harga-container { padding: 15px; }
        .chart-controls { flex-direction: column; } /* Tumpuk kontrol di HP */
        .harga-tabel thead { display: none; }
        .harga-tabel tr { display: block; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #eef; overflow: hidden; }
        .harga-tabel td { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; text-align: right; }
        .harga-tabel td:last-child { border-bottom: 0; }
        .harga-tabel td:first-child { font-weight: bold; background-color: #f9f9fd; }
        .harga-tabel td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 15px; color: #333; }
        .harga-chart-container { height: 250px; }
    }
</style>

<div class="harga-container">
    
    <h2>Histori Harga Emas Galeri24</h2>

    <div class="chart-controls">
        <div class="tab-buttons">
            <button class="active" data-type="jual">Harga Jual</button>
            <button data-type="buyback">Harga Beli</button>
        </div>
        <div class="filter-buttons">
            <button data-days="7">7 Hari</button>
            <button class="active" data-days="30">30 Hari</button>
            <button data-days="all">Semua</button>
        </div>
    </div>
    
    <div class="harga-chart-container">
        <canvas id="harga-chart"></canvas>
    </div>

    <h2>Harga Emas Galeri24 (Hari Ini)</h2>
    <div class="harga-info">
        <span id="harga-diperbarui">Memuat data terbaru...</span>
        <br>
        <small id="waktu-scraping" style="font-weight: normal;"></small>
    </div>
    <table class="harga-tabel">
        <thead>
            <tr>
                <th>Berat (gram)</th>
                <th>Harga Jual</th>
                <th>Harga Buyback</th>
            </tr>
        </thead>
        <tbody id="harga-tbody">
            <tr>
                <td colspan="3" class="harga-loading">Sedang mengambil data...</td>
            </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- URL API KAMU ---
        const LATEST_API_URL = "https://januar001.github.io/scrapper-emas/harga-emas.json";
        const HISTORY_API_URL = "https://januar001.github.io/scrapper-emas/histori.json";
        const cacheBuster = '?v=' + new Date().getTime();

        // --- Variabel Global untuk Chart ---
        let myChart = null; // Ini akan menyimpan objek chart
        let fullHistoriData = []; // Ini akan menyimpan semua data histori
        
        // --- Definisi Warna ---
        const jualConfig = {
            label: 'Harga Jual 1 Gram (Rp)',
            borderColor: '#3f51b5',
            backgroundColor: 'rgba(63, 81, 181, 0.1)'
        };
        const buybackConfig = {
            label: 'Harga Buyback 1 Gram (Rp)',
            borderColor: '#d81b60',
            backgroundColor: 'rgba(216, 27, 96, 0.1)'
        };


        /**
         * FUNGSI UTAMA UNTUK MENG-UPDATE ATAU MEMBUAT CHART
         */
        function updateChart() {
            if (!myChart) return; // Jangan lakukan apa-apa jika chart belum siap

            // 1. Dapatkan status tombol yang aktif
            const activeTab = document.querySelector('.tab-buttons .active').dataset.type;
            const activeFilter = document.querySelector('.filter-buttons .active').dataset.days;

            // 2. Filter data berdasarkan waktu
            let filteredData = fullHistoriData;
            if (activeFilter !== 'all') {
                filteredData = fullHistoriData.slice(-parseInt(activeFilter));
            }

            // 3. Siapkan data untuk chart
            const labels = filteredData.map(item => {
                const date = new Date(item.tanggal);
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
            });
            
            const dataPoints = filteredData.map(item => {
                if (activeTab === 'jual') {
                    return item.harga_jual || item.harga; // 'item.harga' untuk jaga-jaga data lama
                } else {
                    return item.harga_buyback || 0; // '0' jika data buyback belum ada
                }
            });

            // 4. Pilih config warna & label
            const config = (activeTab === 'jual') ? jualConfig : buybackConfig;

            // 5. Update data chart
            myChart.data.labels = labels;
            myChart.data.datasets[0].label = config.label;
            myChart.data.datasets[0].data = dataPoints;
            myChart.data.datasets[0].borderColor = config.borderColor;
            myChart.data.datasets[0].backgroundColor = config.backgroundColor;
            
            // 6. Animasikan perubahan
            myChart.update();
        }

        /**
         * FUNGSI UNTUK MEMBUAT CHART PERTAMA KALI
         */
        function initChart(historiData) {
            fullHistoriData = historiData; // Simpan data utuh
            const ctx = document.getElementById('harga-chart').getContext('2d');
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Awalnya kosong
                    datasets: [{
                        label: '', // Awalnya kosong
                        data: [], // Awalnya kosong
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 },
                    scales: { y: { ticks: { callback: value => 'Rp ' + new Intl.NumberFormat('id-ID').format(value) } } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += 'Rp ' + new Intl.NumberFormat('id-ID').format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Langsung update chart dengan data default (Jual, 30 Hari)
            updateChart();
        }

        /**
         * FUNGSI UNTUK MENGISI TABEL (SAMA)
         */
        function fetchTableData() {
            const elTbody = document.getElementById("harga-tbody");
            const elUpdate = document.getElementById("harga-diperbarui");
            const elScrapeTime = document.getElementById("waktu-scraping");
            
            fetch(LATEST_API_URL + cacheBuster)
                .then(response => response.json())
                .then(data => {
                    elUpdate.innerText = data.diperbarui;
                    try {
                        const scrapeDate = new Date(data.waktu_scraping);
                        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' };
                        elScrapeTime.innerText = `(Data diambil: ${scrapeDate.toLocaleString('id-ID', options)} WIB)`;
                    } catch (e) {}

                    elTbody.innerHTML = "";
                    let htmlRows = "";
                    data.daftar_harga.forEach(item => {
                        htmlRows += `
                            <tr>
                                <td data-label="Berat (gram)">${item.berat}</td>
                                <td data-label="Harga Jual">${item.harga_jual}</td>
                                <td data-label="Harga Buyback">${item.harga_buyback}</td>
                            </tr>
                        `;
                    });
                    elTbody.innerHTML = htmlRows;
                })
                .catch(error => {
                    console.error("Error mengambil data tabel:", error);
                    elUpdate.innerText = "Gagal memuat data tabel.";
                });
        }

        /**
         * FUNGSI UNTUK MENGAMBIL DATA CHART (MODIFIKASI)
         */
        function fetchChartData() {
            fetch(HISTORY_API_URL + cacheBuster)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        initChart(data); // Panggil fungsi initChart, bukan renderChart
                    } else {
                        document.querySelector('.harga-chart-container').style.display = 'none';
                        document.querySelector('.chart-controls').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error mengambil data histori:", error);
                    document.querySelector('.harga-chart-container').style.display = 'none';
                    document.querySelector('.chart-controls').style.display = 'none';
                });
        }
        
        /**
         * FUNGSI UNTUK MENG-HANDLE KLIK TOMBOL
         */
        function setupControls() {
            document.querySelector('.chart-controls').addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') return; // Abaikan jika klik bukan tombol

                const parent = e.target.parentElement;

                // Hapus .active dari semua tombol di grupnya
                parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                
                // Tambahkan .active ke tombol yang diklik
                e.target.classList.add('active');

                // Update chart
                updateChart();
            });
        }

        // --- JALANKAN SEMUA ---
        fetchTableData();
        fetchChartData();
        setupControls();

    });
</script>